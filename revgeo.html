<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>SRG 데이터 역지오코딩 도구</title>
  <meta name="description" content="SRG가 생성하는 random_data.txt 파일의 위경도 좌표를 주소로 변환(역지오코딩)해주는 웹 도구입니다.">
  <meta property="og:type" content="website">
  <meta property="og:title" content="SRG 데이터 역지오코딩 도구">
  <meta property="og:description" content="좌표 데이터를 주소로 변환합니다.">
  <meta property="og:locale" content="ko_KR">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="oklch(97% 0.04 275)">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="oklch(12% 0.08 275)">
  <link rel="icon" href="icon.svg?v=4">
  <link rel="manifest" href="site.webmanifest">
  <link rel="preconnect" href="https://nominatim.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://www.google.com">
  <link rel="dns-prefetch" href="https://www.openstreetmap.org">
  <link rel="dns-prefetch" href="https://map.naver.com">
  <link rel="dns-prefetch" href="https://map.kakao.com">
  <link rel="stylesheet" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css?ver=1.3.9">
  <style>
    @layer reset {
      html {
        container-type: inline-size;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        word-break: keep-all;
        margin-block: 0;
        margin-inline: 0;
        min-block-size: 100dvh;
        text-wrap: pretty;
        container-type: inline-size;
        container-name: page;
      }

      h1,
      h2,
      h3 {
        text-wrap: balance;
      }

      fieldset {
        margin-block: 0;
        margin-inline: 0;
        padding-block: 0;
        padding-inline: 0;
        border: 0;
      }

      p {
        margin-block: 0;
      }
    }

    @layer theme {
      :root {
        color-scheme: light dark;
        --bg-grad-start: light-dark(oklch(97% 0.04 275),
            oklch(12% 0.08 275));
        --bg-grad-end: light-dark(oklch(92% 0.07 285),
            oklch(6% 0.10 270));
        --card-bg: light-dark(oklch(98% 0.03 275 / 0.70),
            oklch(16% 0.06 275 / 0.60));
        --card-border: light-dark(oklch(92% 0.04 275 / 0.5),
            oklch(100% 0.04 275 / 0.12));
        --inner-glow: inset 0 0 0 1px light-dark(oklch(100% 0 0 / 0.2),
            oklch(100% 0.04 275 / 0.1));
        --fg: light-dark(oklch(18% 0.08 275),
            oklch(95% 0.04 275));
        --muted: light-dark(oklch(50% 0.08 275),
            oklch(75% 0.06 275));
        --line: light-dark(oklch(10% 0.06 275 / 0.10),
            oklch(90% 0.04 275 / 0.15));
        --accent: light-dark(oklch(52% 0.28 275),
            oklch(68% 0.24 270));
        --accent-glow: oklch(from var(--accent) l c h / 0.45);
        --success: light-dark(oklch(58% 0.25 150), oklch(70% 0.22 150));
        --warn: light-dark(oklch(70% 0.22 65), oklch(82% 0.20 70));
        --err: light-dark(oklch(58% 0.26 28), oklch(72% 0.24 28));
        --spotlight: light-dark(oklch(40% 0.15 275 / 0.08),
            oklch(80% 0.10 275 / 0.12));
        --shadow-sm:
          0 2px 4px oklch(10% 0.10 275 / 0.05),
          0 1px 2px oklch(10% 0.10 275 / 0.1);
        --shadow-md:
          0 20px 40px -10px oklch(5% 0.15 275 / 0.2),
          var(--inner-glow);
        --glass: blur(20px) saturate(180%);
        --fs-base: clamp(14px, 1.5vw, 15px);
        --fs-sm: clamp(13px, 0.9vw, 14px);
        --fs-lg: clamp(18px, 1.6vw, 22px);
        --fs-xl: clamp(22px, 2vw, 28px);
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      }

      body {
        background-image:
          url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"),
          linear-gradient(in oklch 150deg, var(--bg-grad-start), var(--bg-grad-end));
        color: var(--fg);
        padding-block: 20px;
        padding-inline: 20px;
        letter-spacing: -0.015em;
        transition: opacity 0.2s ease;
        font-variant-numeric: tabular-nums;
        font-size: var(--fs-base);
        line-height: 1.6;

        &::selection {
          background: var(--accent);
          color: oklch(100% 0 0);
        }

        @container (inline-size <=800px) {
          padding-block: 12px;
          padding-inline: 12px;
        }
      }
    }

    @layer layout {
      main {
        inline-size: min(1600px, 100%);
        margin-inline: auto;
        display: grid;
        grid-template-columns: clamp(380px, 28vw, 440px) 1fr;
        gap: 20px;
        block-size: clamp(700px, calc(100dvh - 40px), 1100px);
        transition: grid-template-columns 0.25s ease, block-size 0.25s ease;

        @container (inline-size <=900px) {
          grid-template-columns: 1fr;
          block-size: auto;
        }
      }
    }

    @layer components {
      @keyframes shimmer {
        0% {
          background-position: 150% 0;
        }

        100% {
          background-position: -50% 0;
        }
      }

      .card {
        background: var(--card-bg);
        backdrop-filter: var(--glass);
        border: 1px solid var(--card-border);
        border-radius: clamp(20px, 2vw, 28px);
        padding-block: clamp(20px, 2.5vw, 32px);
        padding-inline: clamp(20px, 2.5vw, 32px);
        box-shadow: var(--shadow-md);
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-inline-size: 100%;
        overflow: hidden;
        position: relative;
        container-type: inline-size;

        .card-header {
          display: flex;
          align-items: baseline;
          gap: 12px;
          flex-wrap: wrap;

          h2 {
            font-size: var(--fs-lg);
            font-weight: 700;
            margin-block: 0;
          }

          .header-desc {
            color: var(--muted);
          }
        }

        >div:has(#coords) {
          flex: 1;
          display: flex;
          flex-direction: column;
          min-block-size: 0;
          gap: 6px;
        }

        footer {
          text-align: center;
          font-size: var(--fs-sm);
          color: var(--muted);
          margin-block: 0;
          line-height: 1.3;
        }

        &::before {
          content: "";
          position: absolute;
          pointer-events: none;
          inset: 0;
          background: radial-gradient(in oklch 800px circle at var(--mouse-x, 0) var(--mouse-y, 0),
              var(--spotlight),
              transparent 40%);
          opacity: 0;
          transition: opacity 0.3s;
          z-index: 1;
        }

        @media (any-hover: hover) {
          &:hover::before {
            opacity: 1;
          }
        }

        &.tap-highlight::before {
          opacity: 1;
        }
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 14px;

        svg {
          color: var(--accent);
          filter: drop-shadow(0 0 12px var(--accent-glow));
          inline-size: 36px;
          block-size: 36px;
        }

        >div {
          h1 {
            margin-block: 0;
            font-size: var(--fs-xl);
            font-weight: 800;
            line-height: 1.1;
            color: var(--accent);
            filter: drop-shadow(0 2px 8px oklch(from var(--accent) l c h / 0.25));
          }

          p {
            color: var(--muted);
            font-size: var(--fs-sm);
            font-weight: 500;
          }
        }
      }

      fieldset.row {
        display: flex;
        flex-direction: column;
        gap: 16px;

        .row {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 10px;
        }
      }

      .drop-zone {
        position: relative;
        border: 2px dashed var(--line);
        border-radius: 18px;
        padding-block: 12px;
        padding-inline: 16px;
        text-align: center;
        transition: all 0.2s ease;
        background: light-dark(oklch(98% 0.02 270 / 0.4), oklch(15% 0.03 270 / 0.4));
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;

        input[type="file"] {
          cursor: pointer;
          position: absolute;
          inset: 0;
          opacity: 0;
        }

        .drop-icon {
          inline-size: 36px;
          block-size: 36px;
          margin-block-end: 4px;
          color: var(--muted);
          transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .drop-text {
          color: var(--muted);
          font-weight: 500;
          font-size: var(--fs-sm);

          strong {
            color: var(--accent);
            font-weight: 700;
          }
        }

        &:hover,
        &:focus-within {
          border-color: var(--accent);
          background: light-dark(oklch(99% 0.02 275 / 0.8), oklch(12% 0.08 275 / 0.4));

          .drop-icon {
            color: var(--accent);
            transform: translateY(-6px) scale(1.1);
            filter: drop-shadow(0 6px 8px var(--accent-glow));
          }
        }

        .mobile-msg {
          display: none;
        }

        @media (pointer: coarse) {
          @container page (inline-size <=800px) {
            padding-block: 16px;

            .desktop-msg {
              display: none;
            }

            .mobile-msg {
              display: inline;
            }
          }
        }

        &[inert] {
          opacity: 0.5;
          cursor: not-allowed;

          .drop-icon {
            filter: none;
            transform: none;
          }

          .drop-text {
            strong {
              color: var(--muted);
            }
          }
        }
      }

      textarea,
      button {
        border-radius: 12px;
        border: 1px solid var(--line);
        background: light-dark(oklch(100% 0 0 / 0.5), oklch(15% 0.04 270 / 0.4));
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      textarea {
        flex: 1;
        resize: none;
        padding-block: 12px;
        padding-inline: 12px;
        min-block-size: 100px;
        field-sizing: content;
        scrollbar-width: thin;
        font-family: inherit;
        font-size: 0.9em;
        line-height: 1.5;

        &:focus {
          outline: none;
          border-color: var(--accent);
          box-shadow: 0 0 0 3px var(--accent-glow);
        }

        &#coords {
          @container page (inline-size <=800px) {
            max-block-size: 30dvh;
            overflow: auto;
          }
        }
      }

      button {
        cursor: pointer;
        font-weight: 600;
        font-size: var(--fs-sm);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-inline-size: 0;
        white-space: nowrap;
        padding-block: 12px;
        padding-inline: 8px;
        position: relative;
        overflow: hidden;
        z-index: 2;

        &::after {
          content: "";
          position: absolute;
          inset: 0;
          background: radial-gradient(in oklch circle at var(--mouse-x, 0) var(--mouse-y, 0),
              oklch(100% 0 0 / 0.2),
              transparent 70%);
          opacity: 0;
          transition: opacity 0.3s;
        }

        &:not(:disabled) {
          &:hover {
            @media (any-hover: hover) {
              &::after {
                opacity: 1;
              }
            }

            background: light-dark(oklch(99% 0 0), oklch(22% 0.04 270));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px -2px oklch(0% 0 0 / 0.15);
            border-color: transparent;
          }

          &:active {
            transform: translateY(0);
          }
        }

        &:disabled {
          opacity: 0.4;
          cursor: not-allowed;
          filter: grayscale(0.8);
        }

        &#parse,
        &#start {
          background: var(--accent);
          color: oklch(99% 0.02 270);
          border-color: transparent;
          box-shadow: 0 4px 12px var(--accent-glow);

          &:not(:disabled) {
            &:hover {
              filter: brightness(1.1);
              box-shadow: 0 8px 16px var(--accent-glow);
            }
          }
        }

        &#stop {
          color: var(--err);
          border-color: oklch(from var(--err) l c h / 0.3);

          &:not(:disabled) {
            &:hover {
              background: var(--err);
              color: white;
              border-color: transparent;
              box-shadow: 0 4px 12px oklch(from var(--err) l c h / 0.4);
            }
          }
        }

        &.tap-highlight::after {
          opacity: 1;
        }
      }

      .row-progress {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        margin-block-start: 8px;

        >.sp {
          flex: 1;
        }

        #counts {
          flex: 0 0 auto;
          font-size: var(--fs-sm);
          text-align: end;
          white-space: nowrap;
          line-height: 1.4;
          color: var(--muted);

          strong {
            color: var(--fg);
          }
        }
      }

      .progress-shell {
        --pct: 0;
        margin-block-start: 8px;
        position: relative;
        border-radius: 999px;
        background: var(--line);
        overflow: hidden;
        block-size: 8px;

        >progress {
          border: none;
          opacity: 0;
        }

        .progress-visual {
          position: absolute;
          inset: 0;
        }

        .progress-fill {
          block-size: 100%;
          transform: scaleX(calc(var(--pct, 0) / 100));
          transform-origin: left;
          background: linear-gradient(in oklch 90deg, var(--accent), var(--success));
          transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        &.active {
          .progress-fill {
            animation: shimmer 1.5s linear infinite;
            background: linear-gradient(in oklch 90deg,
                var(--accent),
                oklch(from var(--success) l c h / 0.8),
                var(--accent));
            background-size: 200% 100%;
          }
        }
      }

      .status {
        padding-block: 12px;
        padding-inline: 16px;
        border-radius: 12px;
        background: light-dark(oklch(15% 0.02 270 / 0.05), oklch(96% 0.02 270 / 0.08));
        border-inline-start: 4px solid var(--muted);
        flex-shrink: 0;
        font-weight: 500;
        font-size: var(--fs-sm);
        transition: opacity 0.3s, transform 0.3s, display 0.3s allow-discrete;

        &:empty {
          display: none;
          opacity: 0;
          transform: translateY(5px);
        }

        @starting-style {
          opacity: 0;
          transform: translateY(5px);
        }

        &.err {
          color: var(--err);
          border-inline-start-color: var(--err);
          background: light-dark(oklch(96% 0.05 28), oklch(25% 0.10 28 / 0.3));
        }

        &.warn {
          color: oklch(from var(--warn) l c h);
          border-inline-start-color: var(--warn);
          background: light-dark(oklch(97% 0.08 65), oklch(25% 0.10 65 / 0.3));
        }

        &.stopped {
          color: var(--muted);
          border-inline-start-color: var(--muted);
          background: light-dark(oklch(94% 0.01 270),
              oklch(20% 0.02 270 / 0.4));
        }
      }

      .table-wrap {
        flex: 1;
        border-radius: 20px;
        border: 1px solid var(--line);
        background: light-dark(oklch(100% 0 0 / 0.4), oklch(0% 0 0 / 0.2));
        overflow: auto;
        scrollbar-gutter: stable;
        position: relative;
        scrollbar-width: thin;
        box-shadow: inset 0 2px 4px oklch(0% 0 0 / 0.03);

        .empty-hint {
          display: flex;
          align-items: center;
          justify-content: center;
          position: absolute;
          inset: 0;
          inset-block-start: 50px;
          color: var(--muted);
          font-size: var(--fs-base);
          z-index: 0;
          pointer-events: none;
        }

        &:has(tbody > tr) .empty-hint {
          display: none;
        }

        @container (inline-size <=900px) {
          &:not(:has(tbody > tr)) {
            min-block-size: 100px;
            overflow: hidden;

            .empty-hint {
              inset-block-start: 0;
            }
          }
        }
      }

      table {
        inline-size: 100%;
        min-inline-size: 900px;
        border-spacing: 0;

        thead {
          th {
            padding-block: 14px;
            padding-inline: 12px;
            border-block-end: 1px solid var(--line);
            position: sticky;
            inset-block-start: 0;
            z-index: 10;
            background: var(--card-bg);
            text-align: start;
            font-weight: 600;
            font-size: var(--fs-sm);
            color: var(--muted);
            white-space: nowrap;

            &:nth-child(1),
            &:nth-child(2) {
              text-align: center;
            }
          }
        }

        tbody {
          td {
            padding-block: 14px;
            padding-inline: 12px;
            border-block-end: 1px solid var(--line);
            vertical-align: top;
            font-size: var(--fs-sm);

            &:nth-child(1),
            &:nth-child(2) {
              text-align: center;
              color: var(--muted);
            }

            &:nth-child(3) {
              color: var(--accent);
              font-weight: 500;
              letter-spacing: -0.03em;
            }

            &:nth-child(9) {
              white-space: nowrap;
            }
          }

          tr {
            content-visibility: auto;
            contain-intrinsic-block-size: auto 136.56px;

            @media (any-hover: hover) {
              &:hover {
                background: light-dark(oklch(97% 0.02 270), oklch(22% 0.04 270));
              }
            }

            &:last-child {
              td {
                border-block-end: none;
              }
            }
          }
        }

        @container (inline-size <=900px) {
          display: block;
          min-inline-size: 0;

          thead {
            display: none;
          }

          tbody {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-block: 16px;
            padding-inline: 16px;

            tr {
              contain-intrinsic-block-size: auto 378.77px;
              display: flex;
              flex-direction: column;
              background: light-dark(oklch(100% 0 0 / 0.4), oklch(20% 0.04 270 / 0.4));
              border: 1px solid var(--line);
              border-radius: 16px;
              padding-block: 16px;
              padding-inline: 16px;
              gap: 10px;
              box-shadow: var(--shadow-sm);

              @media (any-hover: hover) {
                &:hover {
                  transform: translateY(-2px);
                  box-shadow: var(--shadow-md);
                  transition: transform 0.2s;
                  border-color: var(--accent);
                }
              }
            }

            td {
              border: none;
              padding-block: 2px;
              padding-inline: 0;
              display: grid;
              grid-template-columns: 80px 1fr;
              gap: 10px;
              align-items: baseline;
              text-align: start !important;

              &::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--muted);
                font-size: var(--fs-sm);
                text-transform: uppercase;
                letter-spacing: 0.05em;
              }
            }
          }
        }

        .skeleton-bar {
          block-size: 1.1em;
          margin-block: 4px;
          border-radius: 999px;
          background: linear-gradient(in oklch 90deg,
              oklch(from var(--accent) l calc(c * 0.25) h / 0.08),
              oklch(from var(--accent) l calc(c * 0.95) h / 0.3),
              oklch(from var(--accent) l calc(c * 0.40) h / 0.1));
          background-size: 200% 100%;
          animation: shimmer 1.5s infinite;
        }

        .map-links {
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
          padding-block: 0;
          padding-inline: 0;
          margin-block: 0;
          list-style: none;

          a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;

            &:hover {
              color: var(--success);
              text-decoration: underline;
              text-underline-offset: 3px;
            }
          }
        }
      }
    }

    @layer transitions {
      main {
        view-transition-name: app-root;
      }

      .card:first-of-type {
        view-transition-name: controls-card;
      }

      .card:nth-of-type(2) {
        view-transition-name: results-card;
      }

      .row-progress {
        view-transition-name: progress-bar;
      }

      .status {
        view-transition-name: status-bar;
      }

      .table-wrap {
        view-transition-name: results-table;
      }

      ::view-transition-old(app-root),
      ::view-transition-new(app-root) {
        animation-duration: 260ms;
        animation-timing-function: cubic-bezier(0.22, 0.7, 0.3, 1);
      }

      ::view-transition-old(app-root) {
        animation-name: vt-fade-out;
      }

      ::view-transition-new(app-root) {
        animation-name: vt-fade-in;
      }

      ::view-transition-old(results-card),
      ::view-transition-new(results-card),
      ::view-transition-old(results-table),
      ::view-transition-new(results-table),
      ::view-transition-old(progress-bar),
      ::view-transition-new(progress-bar),
      ::view-transition-old(status-bar),
      ::view-transition-new(status-bar) {
        animation-duration: 300ms;
        animation-timing-function: cubic-bezier(0.25, 0.9, 0.35, 1);
      }

      ::view-transition-old(results-card),
      ::view-transition-old(results-table),
      ::view-transition-old(progress-bar),
      ::view-transition-old(status-bar) {
        animation-name: vt-slide-fade-up;
      }

      ::view-transition-new(results-card),
      ::view-transition-new(results-table) {
        animation-name: vt-slide-fade-in-strong;
      }

      ::view-transition-new(progress-bar),
      ::view-transition-new(status-bar) {
        animation-name: vt-slide-fade-in;
      }

      @keyframes vt-fade-in {
        from {
          opacity: 0;
          transform: scale(0.98);
        }

        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes vt-fade-out {
        from {
          opacity: 1;
          transform: scale(1);
        }

        to {
          opacity: 0;
          transform: scale(0.98);
        }
      }

      @keyframes vt-slide-fade-in {
        from {
          opacity: 0;
          transform: translateY(8px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes vt-slide-fade-in-strong {
        from {
          opacity: 0;
          transform: translateY(16px) scale(0.97);
        }

        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes vt-slide-fade-up {
        from {
          opacity: 1;
          transform: translateY(0);
        }

        to {
          opacity: 0;
          transform: translateY(-4px);
        }
      }
    }

    @layer utilities {
      .caps {
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-size: var(--fs-sm);
        font-weight: 700;
        color: var(--muted);
      }

      .sr-only {
        position: absolute;
        inline-size: 1px;
        block-size: 1px;
        overflow: hidden;
        clip-path: inset(50%);
      }
    }
  </style>
</head>

<body>
  <main>
    <section class="card">
      <header class="brand">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" aria-hidden="true">
          <path
            d="M256,0C153.755,0,70.573,83.182,70.573,185.426c0,126.888,165.939,313.167,173.004,321.035 c6.636,7.391,18.222,7.378,24.849,0c7.065-7.868,173.004-194.147,173.004-321.035C441.427,83.182,358.245,0,256,0z M256,278.719c-51.442,0-93.292-41.851-93.292-93.292c0-51.441,41.851-93.292,93.292-93.292 c51.441,0,93.292,41.851,93.292,93.292C349.292,236.868,307.441,278.719,256,278.719z" />
        </svg>
        <div>
          <h1>SRG 역지오코딩</h1>
          <p>random_data.txt 좌표 변환</p>
        </div>
      </header>
      <h2 class="sr-only">파일 업로드 및 실행</h2>
      <form>
        <fieldset class="row">
          <legend class="sr-only">
            random_data.txt 파일 업로드 및 조회 제어
          </legend>
          <label class="drop-zone">
            <svg class="drop-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"
              aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
            </svg>
            <span class="drop-text">
              <span class="desktop-msg">클릭(드래그 앤 드롭)하여
                <strong>random_data.txt</strong> 업로드</span>
              <span class="mobile-msg">터치하여 <strong>random_data.txt</strong> 업로드</span>
            </span>
            <input type="file" id="file" accept=".txt">
          </label>
          <div class="row">
            <button type="button" id="parse">좌표 추출</button>
            <button type="button" id="start" disabled>조회 시작</button>
            <button type="button" id="pause" disabled>일시정지</button>
            <button type="button" id="resume" disabled>재개</button>
            <button type="button" id="stop" disabled>중지</button>
            <button type="button" id="export" disabled>CSV 내보내기</button>
          </div>
        </fieldset>
      </form>
      <div>
        <label for="coords"><span class="caps">추출된 좌표 (lat,lon)</span></label>
        <textarea id="coords" readonly placeholder="좌표가 이곳에 표시됩니다."></textarea>
      </div>
      <div class="row-progress">
        <div class="sp">
          <label class="caps" id="prog-label" for="prog">진행 상황 0%</label>
          <div id="prog-shell" class="progress-shell">
            <progress id="prog" value="0" max="100"></progress>
            <div class="progress-visual">
              <div class="progress-fill"></div>
            </div>
          </div>
        </div>
        <output id="counts">총 <strong id="cnt-total">0</strong>건 중
          <strong id="cnt-success">0</strong>건 완료,<br><strong id="cnt-fail">0</strong>건 실패, <strong
            id="cnt-remain">0</strong>건 미처리</output>
      </div>
      <output id="status" class="status"></output>
      <footer>
        <p>• 품질을 위해 속도는 초당 1회로 제한됩니다.</p>
      </footer>
    </section>
    <section class="card">
      <header class="card-header">
        <h2 id="results-title">결과 표</h2>
        <p class="header-desc">좌표별 주소 및 지도 링크</p>
      </header>
      <div class="table-wrap">
        <p class="empty-hint">
          데이터를 분석하고 조회를 시작하면 결과가 표시됩니다.
        </p>
        <table id="tbl">
          <caption class="sr-only">
            역지오코딩 결과 표
          </caption>
          <thead>
            <tr>
              <th data-col-key="kind">구분</th>
              <th data-col-key="idx">순번</th>
              <th data-col-key="coords">좌표 (위도,경도)</th>
              <th data-col-key="sido">시·도</th>
              <th data-col-key="sigungu">시·군·구</th>
              <th data-col-key="emd">읍·면·동·리</th>
              <th data-col-key="tag">지물 태그</th>
              <th data-col-key="fullAddr">전체주소</th>
              <th data-col-key="maps">지도링크</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
  <template id="tmpl-row-skeleton">
    <tr>
      <td>
        <div class="skeleton-bar"></div>
      </td>
      <td></td>
      <td>
        <div class="skeleton-bar"></div>
      </td>
      <td>
        <div class="skeleton-bar"></div>
      </td>
      <td>
        <div class="skeleton-bar"></div>
      </td>
      <td>
        <div class="skeleton-bar"></div>
      </td>
      <td>
        <div class="skeleton-bar"></div>
      </td>
      <td>
        <div class="skeleton-bar"></div>
      </td>
      <td>
        <div class="skeleton-bar"></div>
      </td>
    </tr>
  </template>
  <template id="tmpl-map-links">
    <ul class="map-links">
      <li>
        <a data-provider-key="Google" data-url-template="https://www.google.com/maps?q={lat},{lon}" target="_blank"
          rel="noopener noreferrer"></a>
      </li>
      <li>
        <a data-provider-key="OSM"
          data-url-template="https://www.openstreetmap.org/search?query={lat},{lon}&zoom=16#map=16/{lat}/{lon}"
          target="_blank" rel="noopener noreferrer"></a>
      </li>
      <li>
        <a data-provider-key="Naver" data-url-template="https://map.naver.com/?lng={lon}&lat={lat}&title={lat}%20{lon}"
          target="_blank" rel="noopener noreferrer"></a>
      </li>
      <li>
        <a data-provider-key="Kakao" data-url-template="https://map.kakao.com/link/map/{lat}%20{lon},{lat},{lon}"
          target="_blank" rel="noopener noreferrer"></a>
      </li>
    </ul>
  </template>
  <noscript>이 도구는 자바스크립트가 필요합니다.</noscript>
  <script type="module">
    const COORD_REGEX =
      /(?<label>대한민국|세계)\s*위경도\s*[:：]\s*(?<lat>[+-]?\d+(?:\.\d+)?)\s*[,，]\s*(?<lon>[+-]?\d+(?:\.\d+)?)/gi;
    const RX_CSV = /[",\n\r]/;
    const csvEsc = (s) => {
      s = String(s ?? "");
      return RX_CSV.test(s) ? `"${s.replaceAll('"', '""')}"` : s;
    };
    const CONFIG = {
      MAX_RETRY: 3,
      REQUEST_TIMEOUT_MS: 10_000,
      RATE_LIMIT_DELAY_MS: 1_000,
      REVERSE_ZOOM: 14,
      SPECIAL_CITIES: /서울|부산|대구|인천|광주|대전|울산|세종/,
    };
    const FETCH_HEADERS = { Accept: "application/json" };
    const BASE_URL = new URL("https://nominatim.openstreetmap.org/reverse");
    BASE_URL.searchParams.set("format", "geocodejson");
    BASE_URL.searchParams.set("zoom", CONFIG.REVERSE_ZOOM);
    BASE_URL.searchParams.set("accept-language", "ko");
    const tmplMapLinks = document.querySelector("#tmpl-map-links");
    const tmplSkeleton = document.querySelector("#tmpl-row-skeleton");
    const MAP_PROVIDERS = Array.from(
      tmplMapLinks.content.querySelectorAll("a[data-url-template]"),
      (a) => {
        const key = a.dataset.providerKey || a.textContent.trim();
        a.textContent = key;
        const template = a.dataset.urlTemplate;
        const url = (lat, lon) =>
          template
            .replaceAll("{lat}", lat)
            .replaceAll("{lon}", lon);
        return { key, url };
      }
    );
    const addrVal = (key) => (r) => r.addr?.[key];
    const BASE_COL_CONFIG = {
      kind: {
        val: (r) => r.set,
      },
      idx: {
        val: (r) => r.idx,
      },
      coords: {
        val: (r) => `${r.lat}, ${r.lon}`,
      },
      sido: { val: addrVal("sido") },
      sigungu: { val: addrVal("sigungu") },
      emd: { val: addrVal("eupmyeon") },
      tag: { val: addrVal("tag") },
      fullAddr: {
        val: (r) => r.fullAddr,
      },
      maps: {
        noCsv: true,
        render: (_, td, r) => {
          const fragment = tmplMapLinks.content.cloneNode(true);
          const anchors = fragment.querySelectorAll("a[data-url-template]");
          let idx = 0;
          for (const a of anchors) {
            const provider = MAP_PROVIDERS[idx++];
            if (!provider) break;
            a.href = provider.url(r.lat, r.lon);
          }
          td.replaceChildren(fragment);
        },
      },
    };
    const numberFormatter = new Intl.NumberFormat("ko-KR");
    const domElements = {
      file: document.querySelector("#file"),
      dropZoneText: document.querySelector(".drop-text"),
      dropZone: document.querySelector(".drop-zone"),
      parse: document.querySelector("#parse"),
      start: document.querySelector("#start"),
      pause: document.querySelector("#pause"),
      resume: document.querySelector("#resume"),
      stop: document.querySelector("#stop"),
      exportBtn: document.querySelector("#export"),
      status: document.querySelector("#status"),
      cntTotal: document.querySelector("#cnt-total"),
      cntSuccess: document.querySelector("#cnt-success"),
      cntFail: document.querySelector("#cnt-fail"),
      cntRemain: document.querySelector("#cnt-remain"),
      progShell: document.querySelector("#prog-shell"),
      prog: document.querySelector("#prog"),
      progLabel: document.querySelector("#prog-label"),
      tbody: document.querySelector("#tbl tbody"),
      coords: document.querySelector("#coords"),
    };
    const COL_DEFS = Array.from(
      document.querySelectorAll("#tbl thead th"),
      (th) => {
        const key = th.dataset.colKey;
        const base = BASE_COL_CONFIG[key] || {};
        return {
          key,
          label: th.textContent.trim(),
          ...base,
        };
      }
    );
    const IDX_COL_INDEX = COL_DEFS.findIndex((c) => c.key === "idx");
    const SKELETON_TEMPLATE = tmplSkeleton.content.querySelector("tr");
    if (SKELETON_TEMPLATE) {
      const skeletonCells = SKELETON_TEMPLATE.querySelectorAll("td");
      COL_DEFS.forEach((col, i) => {
        const td = skeletonCells[i];
        if (!td) return;
        td.dataset.label = col.label;
      });
    }
    const CSV_COLS = COL_DEFS.filter((c) => !c.noCsv);
    const CSV_HEADER_STR = (() => {
      const cols = CSV_COLS.map((c) => csvEsc(c.label));
      const maps = MAP_PROVIDERS.map((p) => csvEsc(`지도링크(${p.key})`));
      return "\uFEFF" + [...cols, ...maps].join(",") + "\n";
    })();
    function getGeocodejsonFeature(data) {
      if (
        !data ||
        typeof data !== "object" ||
        !Array.isArray(data.features)
      ) {
        return null;
      }
      return data.features[0] || null;
    }
    function getLabelParts(gc) {
      const label = String(gc.label || "");
      const rawParts = label.split(",");
      const trimmedParts = rawParts.map((s) => s.trim());
      const nonEmptyParts = trimmedParts.filter(Boolean);
      return { label, trimmedParts, nonEmptyParts };
    }
    const AddressFormatter = {
      _getAdminFromGeocoding(gc, countryCode, nonEmptyLabelParts) {
        const admin = gc.admin || {};
        const entries = Object.entries(admin)
          .map(([key, name]) => {
            const m = /^level(\d+)$/.exec(key);
            return m ? { level: Number(m[1]), name } : null;
          })
          .filter(Boolean)
          .sort((a, b) => a.level - b.level);
        const byLevel = Object.fromEntries(entries.map((e) => [e.level, e.name]));
        const adminCountry = byLevel[2] || "";
        const countryName = gc.country || adminCountry || "";
        const lower = (s) => String(s || "").toLowerCase();
        const lowerCountryName = lower(countryName);
        const lowerAdminCountry = lower(adminCountry);
        const isCountryLike = (name) => {
          const l = lower(name);
          if (!l) return false;
          return l === lowerCountryName || l === lowerAdminCountry;
        };
        const isKoreanPeninsula =
          countryCode === "kr" ||
          countryCode === "kp" ||
          countryName === "대한민국" ||
          countryName === "조선민주주의인민공화국" ||
          lowerCountryName.includes("korea") ||
          lowerAdminCountry.includes("korea");
        let sido = "";
        let sigungu = "";
        let eupmyeon = "";
        const primaryName = gc.name || nonEmptyLabelParts[0] || "";
        const cityDistrict =
          gc.city_district ||
          gc.district ||
          gc.suburb ||
          "";
        const level4 = byLevel[4] || "";
        const level6 = byLevel[6] || "";
        const level7 = byLevel[7] || "";
        const level8 = byLevel[8] || "";
        const level9 = byLevel[9] || "";
        const level10 = byLevel[10] || "";
        const city = gc.city || "";
        const county = gc.county || "";
        if (isKoreanPeninsula) {
          const level6Kr = level6 || level7;
          sido = level4 || gc.state || "";
          if (!sido && city && CONFIG.SPECIAL_CITIES.test(city)) {
            sido = city;
          }
          const looksSiGun = (name = "") => /[시군]$/.test(name);
          const looksGuGun = (name = "") => /[구군]$/.test(name);
          const isSpecialSido = CONFIG.SPECIAL_CITIES.test(sido);
          if (isSpecialSido) {
            const sgCandidates = [
              cityDistrict,
              level6Kr,
              county,
              primaryName,
              nonEmptyLabelParts[0],
              nonEmptyLabelParts[1],
            ].filter(Boolean);
            let picked =
              sgCandidates.find((n) => looksGuGun(n) && n !== sido) ||
              sgCandidates.find(
                (n) =>
                  /시$/.test(n) &&
                  n !== sido &&
                  !CONFIG.SPECIAL_CITIES.test(n)
              ) ||
              "";
            sigungu = picked || "";
          } else {
            const cityLikeCandidates = [
              city,
              county,
              level6Kr,
              primaryName,
              nonEmptyLabelParts[1],
              nonEmptyLabelParts[0],
            ].filter(Boolean);
            const cityLike =
              cityLikeCandidates.find(
                (n) => looksSiGun(n) && n !== sido
              ) || "";
            const districtCandidates = [
              cityDistrict,
              level8,
              level9,
              gc.town,
              gc.locality,
              gc.village,
            ].filter(Boolean);
            const districtLike =
              districtCandidates.find(
                (n) => /구$/.test(n) && n !== cityLike && n !== sido
              ) || "";
            if (cityLike && districtLike && districtLike !== cityLike) {
              sigungu = `${cityLike} ${districtLike}`;
            } else {
              sigungu = cityLike || districtLike || "";
            }
            if (!sigungu) {
              const allCandidates = [
                county,
                level6Kr,
                cityDistrict,
                primaryName,
                nonEmptyLabelParts[0],
                nonEmptyLabelParts[1],
              ].filter(Boolean);
              const fallback =
                allCandidates.find(
                  (n) => (looksSiGun(n) || looksGuGun(n)) && n !== sido
                ) || "";
              if (fallback) sigungu = fallback;
            }
          }
          const emdSet = new Set();
          const addEmd = (name) => {
            if (!name) return;
            if (!/^[\s\S]*[읍면동리]$/.test(name)) return;
            if (name === sido || name === sigungu) return;
            emdSet.add(name);
          };
          addEmd(level8);
          addEmd(level9);
          addEmd(level10);
          addEmd(gc.town);
          addEmd(gc.village);
          addEmd(gc.locality);
          addEmd(gc.suburb);
          addEmd(primaryName);
          addEmd(nonEmptyLabelParts[0]);
          addEmd(nonEmptyLabelParts[1]);
          eupmyeon = Array.from(emdSet).join(" ");
        } else {
          const type = gc.type || "";
          const isCityOrCounty = type === "city" || type === "county";
          sido =
            level4 ||
            gc.state ||
            gc.region ||
            gc.province ||
            gc.county ||
            gc.city ||
            "";
          const cityLikeCandidates = [
            city,
            county,
            level6,
            level7,
            primaryName,
            nonEmptyLabelParts[1],
            nonEmptyLabelParts[0],
          ].filter(Boolean);
          const cityLike =
            cityLikeCandidates.find((n) => n !== sido) || "";
          const districtCandidates = [
            cityDistrict,
            level8,
            level9,
            gc.town,
            gc.locality,
            gc.village,
            gc.suburb,
            gc.neighbourhood,
          ].filter(Boolean);
          const districtLike =
            districtCandidates.find(
              (n) => n !== cityLike && n !== sido
            ) || "";
          if (cityLike && districtLike && cityLike !== districtLike) {
            sigungu = `${cityLike} ${districtLike}`;
          } else {
            sigungu =
              cityLike ||
              districtLike ||
              byLevel[6] ||
              byLevel[8] ||
              gc.city ||
              gc.town ||
              gc.county ||
              gc.district ||
              gc.municipality ||
              "";
          }
          if ((!sigungu || sigungu === sido) && isCityOrCounty) {
            sigungu = primaryName || gc.city || gc.county || "";
          }
          const emdCandidates = [
            gc.locality,
            byLevel[10],
            gc.town,
            gc.village,
            gc.suburb,
            gc.neighbourhood,
            gc.quarter,
            gc.hamlet,
            gc.township,
            gc.residential,
            gc.name,
            nonEmptyLabelParts[0],
            nonEmptyLabelParts[1],
          ].filter((name) => {
            if (!name) return false;
            if (name === sido) return false;
            if (name === cityLike) return false;
            if (name === districtLike) return false;
            return true;
          });
          eupmyeon = emdCandidates[0] || "";
          if (eupmyeon && (eupmyeon === sigungu || eupmyeon === sido)) {
            eupmyeon = "";
          }
          if (
            eupmyeon &&
            isCityOrCounty &&
            eupmyeon === primaryName &&
            eupmyeon === sigungu
          ) {
            eupmyeon = "";
          }
          if (!eupmyeon && districtLike && districtLike !== sido) {
            eupmyeon = districtLike;
            if (sigungu) {
              const esc = (s) =>
                String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
              const re = new RegExp(
                `(?:^|\\s+)${esc(districtLike)}(?:\\s+|$)`,
                "g"
              );
              sigungu = String(sigungu)
                .replace(re, " ")
                .replace(/\s+/g, " ")
                .trim();
            }
          }
        }
        if (!isKoreanPeninsula) {
          if (isCountryLike(sido)) sido = "";
          if (isCountryLike(sigungu)) sigungu = "";
          if (isCountryLike(eupmyeon)) eupmyeon = "";
        }
        if (sido && sigungu && sido === sigungu) {
          sigungu = "";
        }
        return { sido, sigungu, eupmyeon };
      },
      _getTagFromGeocoding(gc, trimmedParts) {
        const firstPart = trimmedParts[0] || "";
        const primary =
          gc.name ||
          firstPart ||
          gc.street ||
          gc.city ||
          "";
        const secondary = gc.type || "";
        return [primary, secondary].filter(Boolean).join(", ");
      },
      parse(data) {
        const feature = getGeocodejsonFeature(data);
        const gc = feature?.properties?.geocoding || null;
        if (!gc) {
          return {
            addr: {
              sido: "",
              sigungu: "",
              eupmyeon: "",
              tag: "",
              fullAddr: "",
            },
            kind: undefined,
          };
        }
        const { label, trimmedParts, nonEmptyParts } = getLabelParts(gc);
        const countryCode = String(gc.country_code || "").toLowerCase();
        const { sido, sigungu, eupmyeon } =
          this._getAdminFromGeocoding(gc, countryCode, nonEmptyParts);
        const tag = this._getTagFromGeocoding(gc, trimmedParts);
        const fullAddr = label;
        const addr = { sido, sigungu, eupmyeon, tag, fullAddr };
        let kind;
        if (countryCode === "kr") kind = "KR";
        else if (countryCode === "kp") kind = "KP";
        else if (countryCode) kind = "WORLD";
        return { addr, kind };
      }
    };
    const AppState = {
      records: [],
      droppedFile: null,
      status: "idle",
      controller: null,
      resumeHandler: null,
      inFlight: false,
      renderReq: null,
      cntSuccess: 0,
      cntFail: 0,
      get isRunning() {
        return (
          this.status === "running" ||
          this.status === "paused" ||
          this.status === "pausing"
        );
      },
      get isBusy() {
        return this.isRunning || this.status === "parsing";
      },
      get isPaused() {
        return this.status === "paused";
      },
      get isPausing() {
        return this.status === "pausing";
      },
      get isStopping() {
        return this.status === "stopping";
      },
      get processedCount() {
        return this.cntSuccess + this.cntFail;
      },
      reset(status = "idle") {
        this.cntSuccess = 0;
        this.cntFail = 0;
        this.status = status;
        this.controller = null;
        this.resumeHandler = null;
        this.inFlight = false;
        if (this.renderReq !== null) {
          cancelAnimationFrame(this.renderReq);
          this.renderReq = null;
        }
        updateUIState();
        scheduleRender();
      },
      setRecords(newRecords) {
        this.records = newRecords;
        this.reset();
      },
      setFile(file) {
        this.droppedFile = file;
      },
      setStatus(st) {
        this.status = st;
        updateUIState();
      },
    };
    const fileDateFmt = new Intl.DateTimeFormat("ko-KR", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
      timeZone: "Asia/Seoul",
    });
    function withViewTransition(fn) {
      if (document.startViewTransition) {
        document.startViewTransition(fn);
      } else {
        fn();
      }
    }
    function updateUIState() {
      const s = AppState.status;
      const hasRecords = AppState.records.length > 0;
      const {
        parse,
        start,
        pause,
        resume,
        stop,
        progShell,
        dropZone,
      } = domElements;
      const isBusy = AppState.isBusy;
      parse.disabled = isBusy;
      start.disabled = isBusy || !hasRecords || s === "stopping";
      pause.disabled = s !== "running";
      resume.disabled = s !== "paused";
      stop.disabled = s === "idle" || s === "stopping";
      progShell.classList.toggle(
        "active",
        s === "running" || s === "pausing"
      );
      const lockInput = isBusy || s === "stopping";
      dropZone?.toggleAttribute("inert", lockInput);
    }
    function setStatusMessage(msg, type = "info") {
      const el = domElements.status;
      el.textContent = msg;
      el.classList.toggle("err", type === "error");
      el.classList.toggle("warn", type === "warn");
      el.classList.toggle("stopped", type === "stopped");
    }
    function renderFrame() {
      AppState.renderReq = null;
      const total = AppState.records.length;
      const processed = AppState.processedCount;
      const success = AppState.cntSuccess;
      const fail = AppState.cntFail;
      const remaining = total - processed;
      domElements.cntTotal.textContent = numberFormatter.format(total);
      domElements.cntSuccess.textContent = numberFormatter.format(success);
      domElements.cntFail.textContent = numberFormatter.format(fail);
      domElements.cntRemain.textContent = numberFormatter.format(remaining);
      const pct = total ? Math.round((processed / total) * 100) : 0;
      domElements.prog.value = pct;
      domElements.progShell.style.setProperty("--pct", pct);
      domElements.progLabel.textContent = `진행 상황 ${pct}%`;
      domElements.exportBtn.disabled = processed === 0;
    }
    function scheduleRender() {
      if (AppState.renderReq !== null) return;
      AppState.renderReq = requestAnimationFrame(renderFrame);
    }
    function clearTable() {
      domElements.tbody.replaceChildren();
    }
    function sleep(ms, signal) {
      const timeoutSig = AbortSignal.timeout(ms);
      const combined =
        signal ? AbortSignal.any([signal, timeoutSig]) : timeoutSig;
      const { promise, resolve, reject } = Promise.withResolvers();
      combined.addEventListener(
        "abort",
        () => {
          if (signal?.aborted) {
            reject(signal.reason);
          } else {
            resolve();
          }
        },
        { once: true }
      );
      return promise;
    }
    const yieldToMain =
      "scheduler" in window && "yield" in window.scheduler
        ? () => window.scheduler.yield()
        : () => {
          const { promise, resolve } = Promise.withResolvers();
          setTimeout(resolve, 0);
          return promise;
        };
    async function* lineIterator(stream) {
      const reader = stream.pipeThrough(new TextDecoderStream()).getReader();
      let remnant = "";
      while (true) {
        const { value: chunk, done } = await reader.read();
        if (done) break;
        const lines = (remnant + chunk).split(/\r\n|\n|\r/);
        remnant = lines.pop() ?? "";
        for (const line of lines) {
          yield line;
        }
      }
      if (remnant) {
        yield remnant;
      }
    }
    async function extractCoordinatesFromStream(file) {
      const out = [];
      let processedLines = 0;
      for await (const line of lineIterator(file.stream())) {
        if (++processedLines % 5000 === 0) {
          await yieldToMain();
        }
        for (const {
          groups: { label, lat, lon },
        } of line.matchAll(COORD_REGEX)) {
          const fLat = +lat;
          const fLon = +lon;
          if (Number.isNaN(fLat) || Number.isNaN(fLon)) continue;
          if (Math.abs(fLat) > 90 || Math.abs(fLon) > 180) continue;
          const setLabel = label === "대한민국" ? "KR" : "WORLD";
          out.push({ lat: fLat, lon: fLon, setLabel });
        }
      }
      return out;
    }
    async function performPauseCheck() {
      if (AppState.isPausing) {
        AppState.setStatus("paused");
        setStatusMessage('일시정지됨. "재개"를 눌러 이어서 진행(단축키 S)', "warn");
        if (!AppState.resumeHandler)
          AppState.resumeHandler = Promise.withResolvers();
        scheduleRender();
        await AppState.resumeHandler.promise;
        if (!AppState.isStopping)
          setStatusMessage("재개합니다… (단축키 Esc로 중지)");
      }
    }
    async function fetchReverseWithRetry(lat, lon, userSignal) {
      let attempt = 0;
      while (attempt < CONFIG.MAX_RETRY) {
        userSignal?.throwIfAborted();
        attempt++;
        try {
          const timeoutSig = AbortSignal.timeout(CONFIG.REQUEST_TIMEOUT_MS);
          const combinedSignal = userSignal
            ? AbortSignal.any([userSignal, timeoutSig])
            : timeoutSig;
          const url = new URL(BASE_URL);
          url.searchParams.set("lat", lat);
          url.searchParams.set("lon", lon);
          const res = await fetch(url, {
            headers: FETCH_HEADERS,
            signal: combinedSignal,
          });

          if (res.ok) {
            return res.json();
          }
          if (res.status === 429 || res.status >= 500) {
            if (attempt >= CONFIG.MAX_RETRY) {
              throw new Error(`HTTP ${res.status}: rate limited or server error`);
            }
            await sleep(CONFIG.RATE_LIMIT_DELAY_MS * attempt, userSignal);
            continue;
          }
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text.slice(0, 200)}`);
        } catch (e) {
          userSignal?.throwIfAborted();
          if (attempt >= CONFIG.MAX_RETRY) {
            throw e;
          }
          await sleep(CONFIG.RATE_LIMIT_DELAY_MS * attempt, userSignal);
        }
      }
    }
    function appendSkeletonRow(idx) {
      const tr = SKELETON_TEMPLATE.cloneNode(true);
      if (IDX_COL_INDEX >= 0) {
        tr.cells[IDX_COL_INDEX].textContent = idx;
      }
      domElements.tbody.append(tr);
      return tr;
    }
    function fillRow(tr, row) {
      COL_DEFS.forEach((col, i) => {
        const td = tr.cells[i];
        td.textContent = "";
        td.className = "";
        td.dataset.label = col.label;
        const val = col.val ? col.val(row) : "";
        if (col.render) col.render(val, td, row);
        else td.textContent = val ?? "";
      });
    }
    function pushResultRow(row) {
      if (row.set === "에러") AppState.cntFail++;
      else AppState.cntSuccess++;
      scheduleRender();
    }
    async function runProcessingLoop() {
      const startIndex = AppState.processedCount;
      for (let i = startIndex; i < AppState.records.length; i++) {
        await performPauseCheck();
        if (!AppState.isRunning) break;
        const r = AppState.records[i];
        AppState.controller = new AbortController();
        AppState.inFlight = true;
        const skeletonTr = appendSkeletonRow(r.idx);
        try {
          if (i > startIndex)
            await sleep(
              CONFIG.RATE_LIMIT_DELAY_MS,
              AppState.controller.signal
            );
          await performPauseCheck();
          if (!AppState.isRunning) {
            skeletonTr.remove();
            break;
          }
          if (!AppState.isPaused)
            setStatusMessage(
              `처리 중… (${i + 1}/${AppState.records.length
              }) (단축키: S=일시정지, Esc=중지)`
            );
          const data = await fetchReverseWithRetry(
            r.lat,
            r.lon,
            AppState.controller.signal
          );
          const { addr, kind } = AddressFormatter.parse(data);
          if (kind) {
            r.set = kind;
          }
          r.addr = addr;
          r.fullAddr = addr.fullAddr;
          fillRow(skeletonTr, r);
          pushResultRow(r);
        } catch (err) {
          const msg = err && (err.message || String(err));
          const isAbort = err && err.name === "AbortError";
          if (AppState.isStopping && isAbort) {
            skeletonTr.remove();
            break;
          }
          console.error(err);
          r.set = "에러";
          r.fullAddr = msg;
          fillRow(skeletonTr, r);
          pushResultRow(r);
          if (!AppState.isStopping)
            setStatusMessage(
              `에러 발생: (${i + 1}/${AppState.records.length}) ${msg}`,
              "error"
            );
        } finally {
          AppState.inFlight = false;
        }
      }
      if (AppState.isStopping) {
        setControlsIdle("중지되었습니다.", "stopped");
      } else if (AppState.processedCount >= AppState.records.length) {
        setControlsIdle("모든 처리가 완료되었습니다.", "info");
      }
    }
    function setControlsIdle(message, type = "info") {
      withViewTransition(() => {
        AppState.setStatus("idle");
        setStatusMessage(message, type);
      });
    }
    function startProcessing() {
      AppState.reset("running");
      clearTable();
      setStatusMessage("조회 시작… (단축키: S=일시정지, Esc=중지)");
      runProcessingLoop();
    }
    domElements.exportBtn.addEventListener("click", async () => {
      try {
        const rows = AppState.records.slice(0, AppState.processedCount);
        if (!rows.length) {
          return setStatusMessage("내보낼 데이터가 없습니다.", "warn");
        }
        const makeRow = (r) => {
          const rowArr = [];
          for (let i = 0; i < CSV_COLS.length; i++) {
            rowArr.push(csvEsc(CSV_COLS[i].val(r)));
          }
          for (let i = 0; i < MAP_PROVIDERS.length; i++) {
            rowArr.push(csvEsc(MAP_PROVIDERS[i].url(r.lat, r.lon)));
          }
          return rowArr.join(",") + "\n";
        };
        const lines = [CSV_HEADER_STR];
        for (const r of rows) lines.push(makeRow(r));
        const dateStr = fileDateFmt.format().replace(/\D/g, "");
        const fileName = `result_${dateStr}.csv`;
        const blob = new Blob(lines, { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
        setStatusMessage("CSV 파일을 다운로드했습니다.");
      } catch (err) {
        console.error(err);
        setStatusMessage(`저장 실패: ${err.message}`, "error");
      }
    });
    async function handleParse() {
      try {
        const file = AppState.droppedFile;
        if (!file) {
          return setStatusMessage("파일을 선택해 주세요.", "warn");
        }
        AppState.setStatus("parsing");
        setStatusMessage("파일 분석 중…");
        const parsed = await extractCoordinatesFromStream(file);
        if (!parsed.length) {
          AppState.setRecords([]);
          domElements.coords.value = "";
          return setStatusMessage("좌표를 찾지 못했습니다.", "warn");
        }
        const records = parsed.map((p, i) => ({
          set: p.setLabel,
          idx: i + 1,
          lat: p.lat,
          lon: p.lon,
        }));
        AppState.setRecords(records);
        const MAX_DISP = 50_000;
        const disp = records
          .slice(0, MAX_DISP)
          .map((r) => `${r.lat},${r.lon}`);
        if (records.length > MAX_DISP)
          disp.push(
            `... 외 ${numberFormatter.format(
              records.length - MAX_DISP
            )}건 생략됨`
          );
        domElements.coords.value = disp.join("\n");
        setStatusMessage(
          `분석 완료: ${records.length}개 좌표. 조회 시작을 누르세요(단축키 S)`
        );
      } catch (err) {
        console.error(err);
        AppState.setStatus("idle");
        setStatusMessage(`오류 발생: ${err.message}`, "error");
      }
    }
    domElements.parse.addEventListener("click", () => {
      void handleParse();
    });
    domElements.start.addEventListener("click", () => {
      withViewTransition(startProcessing);
    });
    domElements.pause.addEventListener("click", () => {
      if (!AppState.isRunning) return;
      withViewTransition(() => {
        AppState.setStatus("pausing");
        if (AppState.inFlight) {
          setStatusMessage("일시정지 요청됨. 현재 작업을 마치고 멈춥니다...", "warn");
        }
      });
    });
    domElements.resume.addEventListener("click", () => {
      if (!AppState.isPaused) return;
      withViewTransition(() => {
        AppState.setStatus("running");
        if (AppState.resumeHandler) {
          AppState.resumeHandler.resolve();
          AppState.resumeHandler = null;
        }
      });
    });
    domElements.stop.addEventListener("click", () => {
      if (!AppState.isRunning) return;
      withViewTransition(() => {
        AppState.setStatus("stopping");
        if (AppState.resumeHandler) {
          AppState.resumeHandler.resolve();
          AppState.resumeHandler = null;
        }
        if (AppState.inFlight && AppState.controller) {
          AppState.controller.abort();
          setStatusMessage("중지 요청됨. 취소 중…", "warn");
        } else {
          setStatusMessage("중지 요청됨. 정리 중…", "warn");
        }
      });
    });
    function handleFile(files) {
      if (!files.length) return;
      if (AppState.isBusy || AppState.isStopping) {
        setStatusMessage("조회/파싱 중에는 파일을 변경할 수 없습니다. 중지 후 다시 선택해 주세요.", "warn");
        domElements.file.value = "";
        return;
      }
      const file = files[0];
      domElements.coords.value = "";
      clearTable();
      AppState.setRecords([]);
      AppState.setFile(file);
      setStatusMessage(`파일 선택됨: ${file.name} 추출 버튼을 누르세요(단축키 P)`);
      domElements.dropZoneText
        .querySelectorAll(".desktop-msg, .mobile-msg")
        .forEach((el) => {
          el.textContent = "선택된 파일: ";
          const strong = document.createElement("strong");
          strong.textContent = file.name;
          el.append(strong);
        });
      domElements.file.value = "";
    }
    domElements.file.addEventListener("change", () => {
      const files = domElements.file.files;
      withViewTransition(() => handleFile(files));
    });
    let moveReq = null;
    let lastEvent = null;
    const hoverPointerQuery = window.matchMedia("(any-hover: hover)");
    function handlePointerMove(e) {
      if (e.pointerType && e.pointerType !== "mouse") return;
      lastEvent = e;
      if (moveReq) return;
      moveReq = requestAnimationFrame(() => {
        moveReq = null;
        const ev = lastEvent;
        if (!ev) return;
        const target = ev.target.closest(".card, button");
        if (!target) return;
        const rect = target.getBoundingClientRect();
        target.style.setProperty("--mouse-x", `${ev.clientX - rect.left}px`);
        target.style.setProperty("--mouse-y", `${ev.clientY - rect.top}px`);
      });
    }
    function updatePointerListener() {
      if (hoverPointerQuery.matches) {
        document.addEventListener("pointermove", handlePointerMove);
      } else {
        document.removeEventListener("pointermove", handlePointerMove);
      }
    }
    updatePointerListener();
    hoverPointerQuery.addEventListener("change", updatePointerListener);
    document.addEventListener("pointerdown", (e) => {
      if (e.pointerType && e.pointerType !== "touch") return;
      const target = e.target.closest(".card, button");
      if (!target) return;
      const rect = target.getBoundingClientRect();
      target.style.setProperty("--mouse-x", `${e.clientX - rect.left}px`);
      target.style.setProperty("--mouse-y", `${e.clientY - rect.top}px`);
      target.classList.add("tap-highlight");
      setTimeout(() => {
        target.classList.remove("tap-highlight");
      }, 250);
    });
    const hotkeys = {
      p: () => {
        if (domElements.parse.disabled) return;
        void handleParse();
      },
      escape: () => {
        if (!domElements.stop.disabled) {
          domElements.stop.click();
        }
      },
      s: () => {
        if (!domElements.resume.disabled) domElements.resume.click();
        else if (!domElements.pause.disabled) domElements.pause.click();
        else if (!domElements.start.disabled) domElements.start.click();
      },
    };
    window.addEventListener("keydown", (e) => {
      if (e.altKey || e.ctrlKey || e.metaKey) return;
      if (e.isComposing) return;
      const key = e.key.toLowerCase();
      const handler = hotkeys[key];
      if (!handler) return;
      e.preventDefault();
      handler();
    });
  </script>
</body>

</html>