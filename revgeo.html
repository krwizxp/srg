<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f9fafb">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f172a">
  <link rel="preconnect" href="https://nominatim.openstreetmap.org">
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ</text></svg>">
  <title>SRG ë°ì´í„° ì—­ì§€ì˜¤ì½”ë”© ë„êµ¬</title>
  <style>
    @layer reset, theme, layout, components, utilities;

    @layer reset {

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        min-height: 100dvh;
      }

      fieldset {
        margin: 0;
        padding: 0;
        border: 0;
      }
    }

    @layer theme {
      :root {
        color-scheme: light dark;
        --card: light-dark(oklch(98% 0.01 240), oklch(15% 0.04 250));
        --line: light-dark(oklch(88% 0.02 240), oklch(25% 0.04 250));
        --muted: light-dark(oklch(55% 0.05 240), oklch(70% 0.05 240));
        --fg: light-dark(oklch(15% 0.03 240), oklch(92% 0.01 240));
        --accent: light-dark(oklch(60% 0.2 260), oklch(70% 0.15 250));
        --accent-2: light-dark(oklch(60% 0.18 150), oklch(75% 0.15 150));
        --warn: light-dark(#d97706, #f59e0b);
        --err: light-dark(#dc2626, #ef4444);
        --shadow: light-dark(0 10px 20px rgba(15, 23, 42, .08), 0 10px 20px rgba(0, 0, 0, .25));
        --shadow-border: light-dark(rgba(148, 163, 184, .7), rgba(15, 23, 42, .8));
        --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        interpolate-size: allow-keywords;
      }

      @property --value {
        syntax: '<number>';
        inherits: true;
        initial-value: 0;
      }

      html {
        scrollbar-color: var(--muted) transparent;
        scrollbar-width: thin;
      }

      body {
        font-family: system-ui, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif;
        font-variant-numeric: tabular-nums;
        background: light-dark(radial-gradient(circle at top left, oklch(95% 0.01 240), oklch(99% 0 0)),
            radial-gradient(circle at top left, oklch(20% 0.04 250), oklch(10% 0.02 260)));
        color: var(--fg);
        accent-color: var(--accent);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: center;
      }

      ::selection {
        background-color: var(--accent);
        color: white;
      }
    }

    @layer layout {

      main,
      header,
      footer {
        width: min(1500px, 100%);
      }

      header {
        padding: 10px 14px;
        border-radius: 14px;
        background: light-dark(radial-gradient(circle at top left, oklch(90% 0.05 250 / 0.8), oklch(98% 0 0 / 0.98)),
            radial-gradient(circle at top left, oklch(30% 0.1 260 / 0.35), oklch(15% 0.04 250 / 0.96)));
        border: 1px solid var(--line);
        box-shadow: var(--shadow), 0 0 0 1px var(--shadow-border);

        h1 {
          margin: 0;
          font-size: 18px;
          letter-spacing: -.02em;
          display: flex;
          align-items: center;
          gap: 8px;
          text-wrap: balance;
        }

        p {
          margin-block-start: 4px;
          font-size: 13px;
          color: var(--muted);
        }

        code {
          font-family: var(--font-mono);
          font-size: 12px;
          padding: 1px 4px;
          border-radius: 4px;
          background: light-dark(rgba(243, 244, 246, .9), rgba(15, 23, 42, .7));
          border: 1px solid light-dark(rgba(148, 163, 184, .8), rgba(148, 163, 184, .7));
        }
      }

      main {
        display: grid;
        grid-template-columns: minmax(380px, 520px) 1fr;
        gap: 12px;
        align-items: stretch;

        @media (max-width: 900px) {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      footer {
        font-size: 11px;
        color: var(--muted);
        text-align: right;

        code {
          font-family: var(--font-mono);
          font-size: 11px;
        }
      }
    }

    @layer components {
      section {
        position: relative;
        overflow: hidden;

        &::before {
          content: "";
          position: absolute;
          inset: -60px;
          background:
            radial-gradient(circle at top left, oklch(70% 0.2 260 / 0.16), transparent 60%),
            radial-gradient(circle at bottom right, oklch(70% 0.2 150 / 0.12), transparent 60%);
          opacity: .9;
          mix-blend-mode: screen;
          pointer-events: none;

          @media (prefers-color-scheme: light) {
            opacity: .7;
            mix-blend-mode: normal;
          }
        }
      }

.card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
        box-shadow: var(--shadow), 0 0 0 1px var(--shadow-border);
        display: flex;
        flex-direction: column;
      }

      .row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;

        &.row-progress {
          align-items: flex-end;
          margin-block-start: 8px;
        }
      }

      .sp {
        flex: 1;
      }

      .caps {
        font-variant: all-small-caps;
        letter-spacing: .4px;
        color: var(--muted);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        white-space: nowrap;
        border: 0;
        clip-path: inset(50%);
      }

      label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--fg);
        user-select: none;
      }

      input[type="file"],
      button {
        border-radius: 10px;
        border: 1px solid var(--line);
        background: transparent;
        color: var(--fg);
        padding: 10px 12px;
        user-select: none;
        caret-color: var(--accent);

        &:active {
          transform: translateY(1px);
        }
      }

      input[type="file"] {
        padding: 6px;

        &::file-selector-button {
          border-radius: 6px;
          border: 1px solid var(--line);
          background: light-dark(rgba(0, 0, 0, 0.05), rgba(255, 255, 255, 0.06));
          color: var(--fg);
          padding: 6px 10px;
          margin-inline-end: 10px;
          cursor: pointer;
          transition: background .2s;

          &:hover {
            background: light-dark(rgba(0, 0, 0, 0.1), rgba(255, 255, 255, 0.1));
          }
        }
      }

      button {
        cursor: pointer;
        background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, 0));
        transition: transform .08s ease, filter .15s ease;

        &:disabled {
          opacity: .5;
          cursor: default;
          filter: grayscale(.6);
        }

        &:not(:disabled):hover {
          transform: translateY(-1px);
          filter: brightness(1.1);
        }
      }

      button:focus-visible,
      input[type="file"]:focus-visible,
      textarea:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      textarea {
        width: 100%;
        min-height: 110px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: light-dark(rgba(249, 250, 251, .96), rgba(15, 23, 42, .8));
        color: var(--fg);
        padding: 8px;
        font-family: var(--font-mono);
        font-size: 12px;
        field-sizing: content;
        max-block-size: 400px;
        caret-color: var(--accent);
        transition: height 0.3s ease, min-height 0.3s ease;

        &::placeholder {
          color: rgba(156, 163, 175, .8);
        }
      }

      .progress-bar {
        --value: 0;
        width: 100%;
        height: 8px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background-color: rgba(15, 23, 42, .85);
        overflow: hidden;
        position: relative;
        transition: --value 0.3s ease-out;

        &::before {
          content: "";
          position: absolute;
          inset: 0;
          transform-origin: left;
          transform: scaleX(calc(var(--value) / 100));
          background: linear-gradient(90deg, var(--accent), var(--accent-2));
          border-radius: inherit;
        }
      }

      .status {
        display: block;
        margin-block-start: 8px;
        font-size: 13px;
        color: var(--muted);
        min-height: 1.2em;

        &.err {
          color: var(--err);
        }

        &.warn {
          color: var(--warn);
        }
      }

      .counts {
        font-size: 12px;
        color: var(--muted);

        strong {
          color: var(--fg);
        }
      }

.table-wrap {
        flex: 1;
        min-height: 0;
        max-height: min(500px, 60vh); 
        overflow: auto;
        content-visibility: auto;
        contain-intrinsic-size: 0 460px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: light-dark(rgba(249, 250, 251, .96), rgba(15, 23, 42, .85));
        box-shadow: var(--shadow), 0 0 0 1px var(--shadow-border);
        scrollbar-gutter: stable;
        overscroll-behavior: contain;
        &:focus-visible {
          outline: 2px solid var(--accent);
          outline-offset: 3px;
        }

        &[data-state="idle"]:not(:has(tbody tr))::after {
          content: "ì•„ì§ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢Œí‘œë¥¼ ì¶”ì¶œí•˜ê³  ì¡°íšŒë¥¼ ì‹œì‘í•´ ì£¼ì„¸ìš”.";
          display: block;
          padding: 24px;
          text-align: center;
          color: var(--muted);
          font-size: 13px;
          pointer-events: none;
        }
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
        min-width: 760px;
      }

      caption {
        text-align: left;
        padding: 8px 10px;
        font-size: 11px;
        color: var(--muted);
      }

      thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid var(--line);
        background-color: color-mix(in srgb, var(--card), transparent 20%);
        backdrop-filter: blur(8px);
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        animation: scroll-shadow linear both;
        animation-timeline: scroll();
        animation-range: 0px 20px;
      }

      @keyframes scroll-shadow {
        to {
          box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.1);
          border-bottom-color: transparent;
        }
      }

      tbody td {
        padding: 10px 12px;
        vertical-align: top;
        overflow-wrap: break-word;
        text-wrap: pretty;
      }

      tbody th {
        vertical-align: top;
        padding: 10px 12px;
        text-align: center;
        font-weight: normal;
        color: var(--muted);
      }

      tbody td:nth-child(3) {
        width: min-content;
        min-width: 85px;
        white-space: normal;
        font-family: var(--font-mono);
        font-size: 11.5px;
        line-height: 1.35;
        color: var(--muted);
      }

      tbody tr {
        border-bottom: 1px dashed var(--line);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        opacity: 1;
        transform: translateY(0);

        @starting-style {
          opacity: 0;
          transform: translateY(10px);
        }

        &:last-child {
          border-bottom: 0;
        }

        &:nth-child(even) {
          background: oklch(from var(--card) calc(l - 0.015) c h);
        }
      }
    }

    @layer utilities {
      #results-title {
        margin: 0 0 8px;
      }

      .tags-cell {
        font-family: var(--font-mono);
        font-size: 12.5px;
        color: var(--muted);
      }

      .nowrap {
        white-space: nowrap;
      }

      .ellipsis {
        max-width: 22ch;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
      }

      a {
        color: var(--accent);
        text-decoration: none;
        text-decoration-thickness: 1px;
        text-underline-offset: 2px;
        text-underline-position: from-font;

        &:hover {
          text-decoration: underline;
        }

        &:focus-visible {
          outline: 2px solid var(--accent-2);
          outline-offset: 2px;
          border-radius: 3px;
        }
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>SRG ë°ì´í„° ì—­ì§€ì˜¤ì½”ë”© ë„êµ¬</h1>
    <p><strong>SRGì˜ random_data.txtì—ì„œ</strong> ì¢Œí‘œë¥¼ ì¶”ì¶œí•´ Nominatim(OpenStreetMap) APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì£¼ì†Œë¥¼ êµ¬í•©ë‹ˆë‹¤.</p>
  </header>
  <main>
    <section class="card" aria-labelledby="controls-title">
      <h2 id="controls-title" class="sr-only">íŒŒì¼ ì—…ë¡œë“œ ë° ì‹¤í–‰</h2>
      <search>
        <form class="row">
          <fieldset class="row">
            <legend class="sr-only">íŒŒì¼ ì—…ë¡œë“œ ë° ì‹¤í–‰</legend>
            <label for="file">random_data.txt</label>
            <input type="file" id="file" accept=".txt">
            <div class="row">
              <button type="button" id="parse" enterkeyhint="done">ì¢Œí‘œ ì¶”ì¶œ</button>
              <button type="button" id="start" enterkeyhint="go" disabled>ì¡°íšŒ ì‹œì‘</button>
              <button type="button" id="pause" disabled>ì¼ì‹œì •ì§€</button>
              <button type="button" id="resume" disabled>ì¬ê°œ</button>
              <button type="button" id="stop" disabled>ì¤‘ì§€</button>
              <button type="button" id="export" disabled>CSV ë‚´ë³´ë‚´ê¸°</button>
            </div>
          </fieldset>
        </form>
      </search>
      <div>
        <label for="coords">
          <span class="caps">ì¶”ì¶œëœ ì¢Œí‘œ (lat,lon)</span>
        </label>
        <textarea id="coords" readonly spellcheck="false" placeholder="random_data.txtì—ì„œ ì¶”ì¶œëœ ì¢Œí‘œê°€ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
      </div>
      <div class="row row-progress">
        <div class="sp">
          <div class="caps" id="prog-label">ì§„í–‰ ìƒí™© 0%</div>
          <div id="prog" class="progress-bar" role="progressbar" aria-labelledby="prog-label" aria-valuemin="0"
            aria-valuemax="100" aria-valuenow="0">
          </div>
        </div>
        <output class="counts" id="counts">
          ì´ <strong>0</strong>ê±´ ì¤‘
          <strong>0</strong>ê±´ ì™„ë£Œ,
          <strong>0</strong>ê±´ ì‹¤íŒ¨,
          <strong>0</strong>ê±´ ë¯¸ì²˜ë¦¬
        </output>
      </div>
      <output id="status" class="status" role="status" aria-live="polite" aria-atomic="true"></output>
    </section>
    <section class="card" aria-labelledby="results-title">
      <h2 id="results-title" class="caps">ê²°ê³¼ í‘œ</h2>
      <div class="table-wrap" role="region" aria-label="ì—­ì§€ì˜¤ì½”ë”© ê²°ê³¼" tabindex="0" data-state="idle">
        <table id="tbl">
          <caption>ê° ì¢Œí‘œë³„ë¡œ ë¶„ë¥˜, ì£¼ì†Œ, í–‰ì •êµ¬ì—­, ì§€ë„ ë§í¬ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</caption>
          <thead>
            <tr>
              <th scope="col">êµ¬ë¶„</th>
              <th scope="col">ìˆœë²ˆ</th>
              <th scope="col">ì¢Œí‘œ (ìœ„ë„,ê²½ë„)</th>
              <th scope="col">ì‹œÂ·ë„</th>
              <th scope="col">ì‹œÂ·êµ°Â·êµ¬</th>
              <th scope="col">ìÂ·ë©´Â·ë™Â·ë¦¬</th>
              <th scope="col">ì§€ë¬¼ íƒœê·¸</th>
              <th scope="col">ì „ì²´ì£¼ì†Œ</th>
              <th scope="col">ì§€ë„ë§í¬</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
  <footer>
    <p>ì„œë¹„ìŠ¤ í’ˆì§ˆì„ ìœ„í•´ ë„ˆë¬´ ë¹ ë¥¸ ìš”ì²­ì€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³µìš© API ì‚¬ìš© ì •ì±…ì„ ì¡´ì¤‘í•´ ì£¼ì„¸ìš”. (<code>nominatim.openstreetmap.org</code> 1req/sec ê¶Œì¥) â€¢
      ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì§§ì€ ëŒ€ê¸° í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.</p>
  </footer>
  <noscript>ì´ ë„êµ¬ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.</noscript>
  <script type="module">
    const els = {
      file: document.getElementById('file'),
      parse: document.getElementById('parse'),
      start: document.getElementById('start'),
      pause: document.getElementById('pause'),
      resume: document.getElementById('resume'),
      stop: document.getElementById('stop'),
      exportBtn: document.getElementById('export'),
      status: document.getElementById('status'),
      counts: document.getElementById('counts'),
      prog: document.getElementById('prog'),
      progLabel: document.getElementById('prog-label'),
      tbody: document.querySelector('#tbl tbody'),
      coords: document.getElementById('coords'),
      tableWrap: document.querySelector('.table-wrap'),
    };
    function setTableState(state) {
      els.tableWrap.setAttribute('data-state', state);
    }
    const nf = new Intl.NumberFormat('ko-KR');
    const listFormatter = new Intl.ListFormat('ko', { style: 'narrow', type: 'unit' });
    const MAX_RETRY = 3;
    const REQUEST_TIMEOUT_MS = 10000;
    const RATE_LIMIT_DELAY_MS = 1000;
    const REVERSE_ZOOM = 14;
    const BASE_COLUMNS = [
      'êµ¬ë¶„',
      'ìˆœë²ˆ',
      'ì¢Œí‘œ (ìœ„ë„,ê²½ë„)',
      'ì‹œÂ·ë„',
      'ì‹œÂ·êµ°Â·êµ¬',
      'ìÂ·ë©´Â·ë™Â·ë¦¬',
      'ì§€ë¬¼ íƒœê·¸',
      'ì „ì²´ì£¼ì†Œ',
    ];
    const MAP_PROVIDERS = [
      { key: 'Google', header: 'ì§€ë„ë§í¬(Google)' },
      { key: 'OSM', header: 'ì§€ë„ë§í¬(OSM)' },
      { key: 'Naver', header: 'ì§€ë„ë§í¬(Naver)' },
      { key: 'Kakao', header: 'ì§€ë„ë§í¬(Kakao)' },
    ];
    let records = [];
    let results = [];
    let stopFlag = false;
    let paused = false;
    let running = false;
    let controller = null;
    let currentIndex = 0;
    let resumeHandler = null;
    let inFlight = false;
    let processedCount = 0;
    let successCount = 0;
    function setStatus(msg, type = 'info') {
      const el = els.status;
      el.textContent = msg;
      el.classList.remove('err', 'warn');
      if (type === 'error') el.classList.add('err');
      else if (type === 'warn') el.classList.add('warn');
    }
    function resetProcessingState(total) {
      results = [];
      currentIndex = 0;
      paused = false;
      processedCount = 0;
      successCount = 0;
      clearTable();
      setProgress(0, total);
      updateCounts();
    }
    function setControlsIdle(message, type = 'info') {
      running = false;
      stopFlag = false;
      setStatus(message, type);
      els.start.disabled = false;
      els.pause.disabled = true;
      els.resume.disabled = true;
      els.stop.disabled = true;
      setTableState('idle');
    }
    function updateCounts() {
      const total = records.length;
      const processed = processedCount;
      const success = successCount;
      const fail = Math.max(0, processed - success);
      const remaining = Math.max(0, total - processed);
      els.counts.innerHTML =
        `ì´ <strong>${nf.format(total)}</strong>ê±´ ì¤‘ ` +
        `<strong>${nf.format(success)}</strong>ê±´ ì™„ë£Œ, ` +
        `<strong>${nf.format(fail)}</strong>ê±´ ì‹¤íŒ¨, ` +
        `<strong>${nf.format(remaining)}</strong>ê±´ ë¯¸ì²˜ë¦¬`;
      els.exportBtn.disabled = processed === 0;
    }
    function setProgress(done, total) {
      const pct = total ? Math.round((done / total) * 100) : 0;
      els.prog.style.setProperty("--value", pct);
      els.prog.setAttribute("aria-valuenow", String(pct));
      els.progLabel.textContent = `ì§„í–‰ ìƒí™© ${pct}%`;
    }
    function clearTable() {
      while (els.tbody.firstChild) els.tbody.removeChild(els.tbody.firstChild);
    }
    function isKR(lat, lon) {
      return lat >= 32 && lat <= 39 && lon >= 124 && lon <= 132;
    }
    function mapLinks(lat, lon) {
      const latStr = String(lat);
      const lonStr = String(lon);
      const zoom = 16;
      const osmQuery = encodeURIComponent(`${latStr},${lonStr}`);
      const title = encodeURIComponent(`${latStr} ${lonStr}`);
      const urlsByKey = {
        Google: `https://www.google.com/maps?q=${latStr},${lonStr}`,
        OSM: `https://www.openstreetmap.org/search?query=${osmQuery}&zoom=${zoom}#map=${zoom}/${latStr}/${lonStr}`,
        Naver: `https://map.naver.com/?lng=${lonStr}&lat=${latStr}&title=${title}`,
        Kakao: `https://map.kakao.com/link/map/${title},${latStr},${lonStr}`,
      };
      return MAP_PROVIDERS.map(p => ({
        label: p.key,
        url: urlsByKey[p.key],
      }));
    }
    function sleep(ms) {
      return new Promise(function (resolve) {
        setTimeout(resolve, ms);
      });
    }
    async function fetchReverseWithRetry(lat, lon, signal) {
      const buildUrl = () => {
        const url = new URL('https://nominatim.openstreetmap.org/reverse');
        url.searchParams.set('format', 'jsonv2');
        url.searchParams.set('lat', String(lat));
        url.searchParams.set('lon', String(lon));
        url.searchParams.set('zoom', String(REVERSE_ZOOM));
        url.searchParams.set('addressdetails', '1');
        url.searchParams.set('accept-language', 'ko');
        return url;
      };
      let attempt = 0;
      while (attempt < MAX_RETRY) {
        attempt++;
        const timeoutSignal = AbortSignal.timeout(REQUEST_TIMEOUT_MS);
        const combinedSignal = signal ? AbortSignal.any([signal, timeoutSignal]) : timeoutSignal;
        const res = await fetch(buildUrl(), {
          headers: { 'Accept': 'application/json' },
          signal: combinedSignal,
        });
        if (res.ok) return res.json();
        if (res.status === 429 || res.status >= 500) {
          await sleep(RATE_LIMIT_DELAY_MS * attempt);
          continue;
        }
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text.slice(0, 200)}`);
      }
      throw new Error('ì¬ì‹œë„ í›„ ì‹¤íŒ¨');
    }
    function appendRow(row) {
      const tr = document.createElement('tr');
      const keys = [...BASE_COLUMNS, 'ì§€ë„ë§í¬'];
      for (const k of keys) {
        const isRowHeader = (k === 'ìˆœë²ˆ');
        const cellTag = (k === 'ì§€ë„ë§í¬') ? 'td' : (isRowHeader ? 'th' : 'td');
        const td = document.createElement(cellTag);
        if (isRowHeader && cellTag === 'th') td.setAttribute('scope', 'row');
        if (k === 'ì§€ë„ë§í¬') {
          td.classList.add('nowrap');
          const links = row[k];
          if (Array.isArray(links)) {
            for (let i = 0; i < links.length; i++) {
              const it = links[i];
              const a = document.createElement('a');
              a.href = it.url;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.textContent = it.label;
              const latlon = String(row['ì¢Œí‘œ (ìœ„ë„,ê²½ë„)']);
              a.setAttribute('aria-label', `${it.label} ì§€ë„ ìƒˆ ì°½ì—ì„œ ì—´ê¸° (${latlon})`);
              td.appendChild(a);
              if (i < links.length - 1) {
                td.appendChild(document.createTextNode(' Â· '));
              }
            }
          }
        } else {
          td.textContent = row[k] ?? '';
          if (k === 'ì§€ë¬¼ íƒœê·¸') td.className = 'tags-cell';
          if (k === 'ìÂ·ë©´Â·ë™Â·ë¦¬') {
            td.classList.add('nowrap', 'ellipsis');
            td.title = row[k] ?? '';
          }
        }
        tr.appendChild(td);
      }
      els.tbody.appendChild(tr);
    }
    function toCSV(rows) {
      if (!rows.length) return '';
      const headers = [
        ...BASE_COLUMNS,
        ...MAP_PROVIDERS.map(p => p.header),
      ];
      const escape = (s) => {
        if (s == null) return '';
        s = String(s);
        if (/[",\n]/.test(s)) return '"' + s.replaceAll('"', '""') + '"';
        return s;
      };
      const lines = [headers.join(',')];
      for (const r of rows) {
        const links = Array.isArray(r['ì§€ë„ë§í¬']) ? r['ì§€ë„ë§í¬'] : [];
        const linkMap = Object.fromEntries(links.map(l => [l.label, l.url]));
        const baseVals = BASE_COLUMNS.map(col => r[col]);
        const linkVals = MAP_PROVIDERS.map(p => linkMap[p.key] || '');
        const rowVals = [...baseVals, ...linkVals];
        lines.push(rowVals.map(escape).join(','));
      }
      return lines.join('\n');
    }
    function exportCSV() {
      const csv = toCSV(results);
      if (!csv) {
        setStatus('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warn');
        return;
      }
      const bom = '\uFEFF';
      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reverse_geocode_results.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      setStatus('CSV íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
    }
    function extractCoordinates(text) {
      const out = [];
      const push = (lat, lon, setLabel) => {
        if (
          Number.isFinite(lat) && Number.isFinite(lon) &&
          Math.abs(lat) <= 90 && Math.abs(lon) <= 180
        ) {
          out.push({ lat, lon, setLabel });
        }
      };
      const krRe = /ëŒ€í•œë¯¼êµ­\s*ìœ„ê²½ë„\s*[:ï¼š]\s*([+-]?\d+(?:\.\d+)?)\s*[,ï¼Œ]\s*([+-]?\d+(?:\.\d+)?)/gi;
      const worldRe = /ì„¸ê³„\s*ìœ„ê²½ë„\s*[:ï¼š]\s*([+-]?\d+(?:\.\d+)?)\s*[,ï¼Œ]\s*([+-]?\d+(?:\.\d+)?)/gi;
      const pairRe = /([+-]?\d+(?:\.\d+)?)\s*[,ï¼Œ]\s*([+-]?\d+(?:\.\d+)?)/g;
      for (const m of text.matchAll(krRe)) {
        push(parseFloat(m[1]), parseFloat(m[2]), 'KR');
      }
      for (const m of text.matchAll(worldRe)) {
        push(parseFloat(m[1]), parseFloat(m[2]), 'WORLD');
      }
      if (out.length) return out;
      const lines = text.split(/\r?\n/);
      const firstLine = lines.find(l => l.trim().length);
      if (firstLine && /lat|longitude|ìœ„ë„|ê²½ë„/i.test(firstLine)) {
        const hdr = firstLine.split(/,|\t|\s{2,}/);
        const idxLat = hdr.findIndex(h => /^(lat|latitude|ìœ„ë„)$/i.test(h.trim()));
        const idxLon = hdr.findIndex(h => /^(lon|lng|longitude|ê²½ë„)$/i.test(h.trim()));
        if (idxLat >= 0 && idxLon >= 0) {
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;
            const cols = line.split(/,|\t|\s{2,}/);
            const lat = parseFloat(cols[idxLat]);
            const lon = parseFloat(cols[idxLon]);
            push(lat, lon);
          }
          if (out.length) return out;
        }
      }
      for (const m of text.matchAll(pairRe)) {
        push(parseFloat(m[1]), parseFloat(m[2]));
      }
      return out;
    }
    function buildResultRow(kind, r, extra) {
      const base = {
        'êµ¬ë¶„': kind,
        'ìˆœë²ˆ': r.idx,
        'ì¢Œí‘œ (ìœ„ë„,ê²½ë„)': `${r.lat}, ${r.lon}`,
        'ì‹œÂ·ë„': '',
        'ì‹œÂ·êµ°Â·êµ¬': '',
        'ìÂ·ë©´Â·ë™Â·ë¦¬': '',
        'ì§€ë¬¼ íƒœê·¸': '',
        'ì „ì²´ì£¼ì†Œ': '',
        'ì§€ë„ë§í¬': [],
      };
      return { ...base, ...extra };
    }
    async function runProcessingLoop() {
      for (let i = currentIndex; i < records.length; i++) {
        if (!running || stopFlag) break;
        if (paused && resumeHandler) {
          setStatus('ì¼ì‹œì •ì§€ë¨. "ì¬ê°œ"ë¥¼ ëˆ„ë¥´ë©´ ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤. (ë‹¨ì¶•í‚¤ \S\ë¡œ ì¬ê°œ)', 'warn');
          await resumeHandler.promise;
        }
        if (!running || stopFlag) break;
        currentIndex = i;
        const r = records[i];
        const { lat, lon } = r;
        controller = new AbortController();
        inFlight = true;
        try {
          await sleep(RATE_LIMIT_DELAY_MS);
          if (!running || stopFlag) break;
          if (!paused) {
            setStatus(`ì²˜ë¦¬ ì¤‘â€¦ (${i + 1}/${records.length}) (ë‹¨ì¶•í‚¤: S=ì¼ì‹œì •ì§€, Esc=ì¤‘ì§€)`);
          }
          const data = await fetchReverseWithRetry(lat, lon, controller.signal);
          const addr = data.address ?? {};
          const { sido, sigungu, eupmyeon, tag } = toKoreanAddressParts(addr, data);
          const linkset = mapLinks(lat, lon);
          const row = buildResultRow(r.set, r, {
            'ì‹œÂ·ë„': sido,
            'ì‹œÂ·êµ°Â·êµ¬': sigungu,
            'ìÂ·ë©´Â·ë™Â·ë¦¬': eupmyeon,
            'ì§€ë¬¼ íƒœê·¸': tag,
            'ì „ì²´ì£¼ì†Œ': data.display_name || '',
            'ì§€ë„ë§í¬': linkset,
          });
          pushResultRow(row);
        } catch (err) {
          const msg = err && (err.message || String(err));
          const isAbort = err && (err.name === 'AbortError' || /aborted/i.test(msg));
          if (stopFlag && isAbort) break;
          console.error(err);
          const row = buildResultRow('ì—ëŸ¬', r, { 'ì „ì²´ì£¼ì†Œ': msg });
          pushResultRow(row);
          if (!stopFlag) {
            setStatus(`ì—ëŸ¬ ë°œìƒ: (${i + 1}/${records.length}) ${msg}`, 'error');
          }
        } finally {
          inFlight = false;
          updateCounts();
        }
      }
      if (stopFlag) {
        setControlsIdle('ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warn');
      } else if (currentIndex >= records.length - 1) {
        setControlsIdle('ëª¨ë“  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }
    function pushResultRow(row) {
      results.push(row);
      if (row['êµ¬ë¶„'] !== 'ì—ëŸ¬') {
        successCount++;
      }
      processedCount++;
      appendRow(row);
      currentIndex++;
      setProgress(currentIndex, records.length);
    }
    async function yieldToMain() {
      if ('scheduler' in window && 'yield' in window.scheduler) {
        await window.scheduler.yield();
      } else {
        await new Promise(r => setTimeout(r, 0));
      }
    }
    els.parse.addEventListener('click', async () => {
      try {
        if (running) {
          setStatus('í˜„ì¬ ì—­ì§€ì˜¤ì½”ë”©ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ì§€ í›„ ë‹¤ì‹œ ì¢Œí‘œë¥¼ ì¶”ì¶œí•´ ì£¼ì„¸ìš”.', 'warn');
          return;
        }
        els.start.disabled = true;
        els.exportBtn.disabled = true;
        const file = els.file.files?.[0];
        if (!file) {
          setStatus('ë¨¼ì € random_data.txt íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.', 'warn');
          return;
        }
        setStatus('íŒŒì¼ ì½ëŠ” ì¤‘â€¦');
        const text = await file.text();
        setStatus('ì¢Œí‘œ ì¶”ì¶œ ì¤‘â€¦');
        await yieldToMain();
        const parsed = extractCoordinates(text);
        if (!parsed.length) {
          records = [];
          resetProcessingState(0);
          els.coords.value = '';
          els.start.disabled = true;
          setStatus(
            'ì¢Œí‘œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¼ë²¨(ëŒ€í•œë¯¼êµ­/ì„¸ê³„ ìœ„ê²½ë„) ë˜ëŠ” "ìœ„ë„,ê²½ë„" í˜•íƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.',
            'warn'
          );
          return;
        }
        records = parsed.map((p, i) => ({
          set: p.setLabel ? (p.setLabel === 'KR' ? 'KR' : 'WORLD') : (isKR(p.lat, p.lon) ? 'KR' : 'WORLD'),
          idx: i + 1,
          lat: p.lat,
          lon: p.lon
        }));
        els.coords.value = records
          .map(r => `${r.lat},${r.lon}`)
          .join('\n');
        resetProcessingState(records.length);
        setControlsIdle(
          `ë¶„ì„ ì™„ë£Œ: ${records.length}ê°œ ì¢Œí‘œ ë°œê²¬. "ì¡°íšŒ ì‹œì‘(ë‹¨ì¶•í‚¤ \S\)"ì„ ëˆ„ë¥´ì„¸ìš”.`
        );
      } catch (err) {
        console.error(err);
        setStatus(`ì˜¤ë¥˜ ë°œìƒ: ${err.message}`, 'error');
        els.start.disabled = true;
      }
    });
    els.start.addEventListener('click', () => {
      if (!document.startViewTransition) {
        startProcessing();
      } else {
        document.startViewTransition(() => {
          startProcessing();
        });
      }
    });
    function startProcessing() {
      stopFlag = false;
      running = true;
      resetProcessingState(records.length);
      setStatus('ì¡°íšŒ ì‹œì‘â€¦ (ë‹¨ì¶•í‚¤: S=ì¼ì‹œì •ì§€, Esc=ì¤‘ì§€)');
      els.start.disabled = true;
      els.pause.disabled = false;
      els.resume.disabled = true;
      els.stop.disabled = false;
      setTableState('running');
      runProcessingLoop();
    }
    els.pause.addEventListener('click', () => {
      if (!running) return;
      paused = true;
      if (!resumeHandler) {
        resumeHandler = Promise.withResolvers();
      }
      if (inFlight) {
        setStatus('ì¼ì‹œì •ì§€ ìš”ì²­ë¨. í˜„ì¬ ì‘ì—…ì„ ë§ˆì¹˜ê³  ë©ˆì¶¥ë‹ˆë‹¤...', 'warn');
      } else {
        setStatus('ì¼ì‹œì •ì§€ë¨. "ì¬ê°œ"ë¥¼ ëˆ„ë¥´ë©´ ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤. (ë‹¨ì¶•í‚¤ \S\ë¡œ ì¬ê°œ)', 'warn');
      }
      els.pause.disabled = true;
      els.resume.disabled = false;
    });
    els.resume.addEventListener('click', () => {
      if (!running || !paused) return;
      paused = false;
      setStatus('ì¬ê°œí•©ë‹ˆë‹¤â€¦ (ë‹¨ì¶•í‚¤ Escë¡œ ì¤‘ì§€)');
      if (resumeHandler) {
        resumeHandler.resolve();
        resumeHandler = null;
      }
      els.pause.disabled = false;
      els.resume.disabled = true;
    });
    els.stop.addEventListener('click', () => {
      if (!running) return;
      stopFlag = true;
      if (paused && resumeHandler) {
        resumeHandler.resolve();
        resumeHandler = null;
        paused = false;
      }
      if (inFlight && controller) {
        controller.abort();
        setStatus('ì¤‘ì§€ ìš”ì²­ë¨. í˜„ì¬ ìš”ì²­ì„ ì·¨ì†Œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦', 'warn');
      } else {
        setControlsIdle('ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warn');
      }
    });
    els.exportBtn.addEventListener('click', exportCSV);
    els.file.addEventListener('change', () => {
      if (els.file.files.length > 0) {
        const name = els.file.files[0].name;
        setStatus(`íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤: ${name} (ë‹¨ì¶•í‚¤ Pë¥¼ ëˆŒëŸ¬ ì¶”ì¶œí•˜ì„¸ìš”)`);
      }
    });
    const dropZone = document.body;
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.opacity = '0.8';
    });
    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.style.opacity = '1';
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.opacity = '1';
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const f = files[0];
        if (f.type && !f.type.startsWith('text/')) {
          setStatus('í…ìŠ¤íŠ¸ íŒŒì¼(.txt)ë§Œ ì§€ì›í•©ë‹ˆë‹¤.', 'warn');
          return;
        }
        els.file.files = files;
        setStatus(`íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤: ${f.name} (ë‹¨ì¶•í‚¤ Pë¥¼ ëˆŒëŸ¬ ì¶”ì¶œí•˜ì„¸ìš”)`);
      }
    });
    window.addEventListener('keydown', (e) => {
      const active = document.activeElement;
      if (active.tagName === 'TEXTAREA' || (active.tagName === 'INPUT' && active.type === 'text')) {
        return;
      }
      const key = e.key.toLowerCase();
      if (key === 'p' && !els.parse.disabled) {
        e.preventDefault();
        els.parse.click();
      }
      if (e.key === 'Escape' && !els.stop.disabled) {
        e.preventDefault();
        els.stop.click();
      }
      if (key === 's') {
        if (!els.resume.disabled) {
          e.preventDefault();
          els.resume.click();
        } else if (!els.pause.disabled) {
          e.preventDefault();
          els.pause.click();
        } else if (!els.start.disabled) {
          e.preventDefault();
          els.start.click();
        }
      }
    });
    function toKoreanAddressParts(a, data) {
      const countryCode = (a.country_code || '').toLowerCase();
      const isKR = countryCode === 'kr' || a.country === 'ëŒ€í•œë¯¼êµ­';
      let sido = '';
      let sigungu = '';
      let eupmyeon = '';
      if (isKR) {
        sido = a.province || a.state || a.region || '';
        let tmpCity = a.city || a.county || a.municipality || '';
        let tmpGu = a.district || a.borough || a.suburb || '';
        const specialCities = ['ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ì„¸ì¢…'];
        const isSpecialCity = specialCities.some(c => tmpCity.includes(c));
        if (!sido && isSpecialCity) {
          sido = tmpCity;
          sigungu = tmpGu;
        } else {
          sigungu = tmpCity;
          if (tmpCity && tmpGu && tmpCity !== tmpGu) {
            if (!sigungu.includes(tmpGu)) {
              sigungu += ' ' + tmpGu;
            }
          } else if (!sigungu) {
            sigungu = tmpGu;
          }
        }
        const emd = a.town || a.township || a.neighbourhood || a.city_district || '';
        const ri = a.village || a.hamlet || '';
        eupmyeon = [emd, ri].filter(Boolean).join(' ');
      } else {
        sido = a.state || a.region || a.province || a.county || a.city || '';
        sigungu = a.city || a.town || a.county || a.district || a.municipality || a.region || '';
        eupmyeon = a.village || a.suburb || a.neighbourhood || a.quarter || a.hamlet || a.city_district || a.township || a.residential || '';
      }
      let tag = '';
      if (data && typeof data === 'object') {
        const name = data.name || a.attraction || a.building || '';
        const addType = data.addresstype || '';
        const category = data.category || '';
        const type = data.type || '';
        const parts = [];
        if (name) parts.push(name);
        if (addType && addType !== name) parts.push(addType);
        else if (category && category !== name) parts.push(category);
        if (parts.length > 0) {
          tag = listFormatter.format(parts);
        }
      }
      return { sido, sigungu, eupmyeon, tag };
    }
  </script>
</body>

</html>